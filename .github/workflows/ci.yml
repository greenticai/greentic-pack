name: CI & Publish

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  fmt:
    name: CI (fmt)
    runs-on: ubuntu-latest
    env:
      CARGO_TARGET_DIR: target/ci
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.91.0
        with:
          components: rustfmt
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-rust-1.91-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
      - run: cargo fmt --all -- --check

  clippy:
    name: CI (clippy)
    runs-on: ubuntu-latest
    env:
      CARGO_TARGET_DIR: target/ci
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.91.0
        with:
          components: clippy
      - name: Check for duplicate canonical WIT
        run: bash ci/check_no_duplicate_canonical_wit.sh
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-rust-1.91-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
      - run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  test:
    name: CI (build/test)
    runs-on: ubuntu-latest
    env:
      CARGO_TARGET_DIR: target/ci
      TMPDIR: /tmp/greentic-pack-tmp
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.91.0
      - name: Prepare temp dir
        run: mkdir -p "$TMPDIR"
      - name: Check for duplicate canonical WIT
        run: bash ci/check_no_duplicate_canonical_wit.sh
      - name: Install mold + clang (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y mold clang
      - name: Configure mold for native Linux builds
        if: runner.os == 'Linux'
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml <<'EOF'
          [target.x86_64-unknown-linux-gnu]
          linker = "clang"
          rustflags = ["-C", "link-arg=-fuse-ld=mold"]
          EOF
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-rust-1.91-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
      - name: Install mold + clang (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y mold clang
      - name: Configure mold for native Linux builds
        if: runner.os == 'Linux'
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml <<'EOF'
          [target.x86_64-unknown-linux-gnu]
          linker = "clang"
          rustflags = ["-C", "link-arg=-fuse-ld=mold"]
          EOF
      - name: Cache cargo-binstall
        id: cache-cargo-binstall
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/cargo-binstall
            ~/.cargo/.binstall
          key: cargo-binstall-${{ runner.os }}-rust-1.91.0
      - name: Ensure cargo-binstall
        run: |
          if [ ! -x "$HOME/.cargo/bin/cargo-binstall" ]; then
            cargo install cargo-binstall --locked
          fi
      - name: Install wasm32-wasip2 target
        run: rustup target add wasm32-wasip2
      - name: Install greentic tooling
        run: |
          set -euo pipefail
          BINSTALL_DISABLE_STRATEGIES=compile cargo binstall cargo-component -y --force || cargo install cargo-component --locked --force
          BINSTALL_DISABLE_STRATEGIES=compile cargo binstall greentic-component -y --force
          BINSTALL_DISABLE_STRATEGIES=compile cargo binstall wasm-tools -y --force
      - run: cargo build --workspace --all-features --locked
      - run: cargo test --workspace --all-features --locked -- --nocapture

  publish:
    name: Publish crates
    needs: [fmt, clippy, test]
    if: >-
      (github.event_name == 'push' && github.ref == 'refs/heads/master')
      || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
    runs-on: ubuntu-latest
    env:
      CARGO_TARGET_DIR: target/ci
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.91.0
      - name: Install mold + clang (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y mold clang
      - name: Configure mold for native Linux builds
        if: runner.os == 'Linux'
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml <<'EOF'
          [target.x86_64-unknown-linux-gnu]
          linker = "clang"
          rustflags = ["-C", "link-arg=-fuse-ld=mold"]
          EOF
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-rust-1.91-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
      - name: Publish changed crates
        uses: katyo/publish-crates@v2
        with:
          path: .
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          ignore-unpublished-changes: true
          check-repo: true
          dry-run: false
      - name: Note already-published versions
        if: always()
        run: echo "If cargo publish reported 'already exists on crates.io index', no new publish was performed (expected and non-fatal)."

  release:
    name: Build binaries + Release
    needs: publish
    if: needs.publish.result == 'success'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    permissions:
      contents: write
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.91.0
        with:
          targets: ${{ matrix.target }}
      - name: Install target
        run: rustup target add ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-${{ runner.os }}-${{ matrix.target }}-rust-1.91-${{ hashFiles('**/Cargo.lock') }}
      - name: Install mold + clang (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y mold clang
      - name: Configure mold for native Linux builds
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml <<'EOF'
          [target.x86_64-unknown-linux-gnu]
          linker = "clang"
          rustflags = ["-C", "link-arg=-fuse-ld=mold"]
          EOF
      - name: Derive release tag and title from workspace version
        run: |
          set -euo pipefail
          version=$(perl -ne 'print $1 if /^version\s*=\s*"([^"]+)"/' Cargo.toml | head -n 1)
          tag="v${version}"
          echo "RELEASE_TAG=${tag}" >> "$GITHUB_ENV"
          echo "RELEASE_TITLE=${tag}" >> "$GITHUB_ENV"
      - name: Build binstall artifacts
        run: |
          set -euo pipefail
          cargo build --release --target ${{ matrix.target }} --package greentic-pack --bin greentic-pack
          out_dir="target/${{ matrix.target }}/release"
          mkdir -p dist
          if [[ "${{ matrix.target }}" == *"windows-msvc" ]]; then
            powershell.exe -NoProfile -Command "Compress-Archive -Path '${out_dir}/greentic-pack.exe' -DestinationPath 'dist/greentic-pack-${{ matrix.target }}.zip' -Force"
          else
            tar -czf "dist/greentic-pack-${{ matrix.target }}.tgz" -C "${out_dir}" greentic-pack
          fi
      - name: Upload binstall artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/greentic-pack-${{ matrix.target }}.*
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TITLE }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
